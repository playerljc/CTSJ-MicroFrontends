{"version":3,"file":"component.js","sources":["component.js"],"sourcesContent":["\"use strict\";\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.createComponent = void 0;\r\nvar react_1 = __importDefault(require(\"react\"));\r\nvar context_1 = __importDefault(require(\"./context\"));\r\n/**\r\n * loadScript\r\n * @param script\r\n * @return Promise\r\n */\r\nfunction loadScript(script) {\r\n    return new Promise(function (resolve) {\r\n        var el = document.createElement('script');\r\n        el.addEventListener('load', function () {\r\n            resolve();\r\n        });\r\n        el.src = script;\r\n        document.getElementsByTagName('head')[0].appendChild(el);\r\n    });\r\n}\r\n/**\r\n * loadLink\r\n * @param link\r\n * @return Promise\r\n */\r\nfunction loadLink(link) {\r\n    return new Promise(function (resolve) {\r\n        var el = document.createElement('link');\r\n        el.setAttribute('rel', 'stylesheet');\r\n        el.addEventListener('load', function () {\r\n            resolve();\r\n        });\r\n        el.href = link;\r\n        document.getElementsByTagName('head')[0].appendChild(el);\r\n    });\r\n}\r\n// @ts-ignore\r\n/**\r\n * loadRemoteResource - 加载远程资源\r\n * @param scripts\r\n * @param links\r\n * @return Promise\r\n */\r\nfunction loadRemoteResource(_a) {\r\n    var scripts = _a.scripts, links = _a.links;\r\n    // @ts-ignore\r\n    return Promise.all([].concat(\r\n    // @ts-ignore\r\n    (scripts || []).map(function (script) { return loadScript(script); }), (links || []).map(function (link) { return loadLink(link); })));\r\n}\r\n/**\r\n * createComponent\r\n * @param config\r\n * @param container\r\n * @return React.ReactElement\r\n */\r\nfunction createComponent(config, container) {\r\n    // @ts-ignore\r\n    return /** @class */ (function (_super) {\r\n        __extends(ComponentWrap, _super);\r\n        // @ts-ignore\r\n        function ComponentWrap(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            _this.el = null;\r\n            _this.lock = false;\r\n            _this.state = {\r\n                isReady: false,\r\n            };\r\n            _this.refresh = _this.refresh.bind(_this);\r\n            return _this;\r\n        }\r\n        ComponentWrap.prototype.componentDidMount = function () {\r\n            var _this = this;\r\n            var _a, _b, _c;\r\n            var name = config.name;\r\n            // 如果没有加载远程资源，则加载远程资源\r\n            // @ts-ignore\r\n            if (!window[name]) {\r\n                var scripts = config.scripts, links = config.links;\r\n                loadRemoteResource({\r\n                    scripts: scripts,\r\n                    // @ts-ignore\r\n                    links: links,\r\n                }).then(function () {\r\n                    var _a, _b, _c;\r\n                    // @ts-ignore\r\n                    (_a = window[name]) === null || _a === void 0 ? void 0 : _a.bootstrap({\r\n                        props: _this.props,\r\n                        config: config,\r\n                        el: _this.el || container,\r\n                        refresh: _this.refresh,\r\n                    });\r\n                    // @ts-ignore\r\n                    (_c = (_b = window[name]) === null || _b === void 0 ? void 0 : _b.mount()) === null || _c === void 0 ? void 0 : _c.then(function () {\r\n                        _this.setState({\r\n                            isReady: true,\r\n                        });\r\n                    });\r\n                });\r\n            }\r\n            // 加载过远程资源\r\n            else {\r\n                // @ts-ignore\r\n                (_a = window[name]) === null || _a === void 0 ? void 0 : _a.bootstrap({\r\n                    props: this.props,\r\n                    config: config,\r\n                    el: this.el || container,\r\n                    refresh: this.refresh,\r\n                });\r\n                // @ts-ignore\r\n                (_c = (_b = window[name]) === null || _b === void 0 ? void 0 : _b.mount()) === null || _c === void 0 ? void 0 : _c.then(function () {\r\n                    _this.setState({\r\n                        isReady: true,\r\n                    });\r\n                });\r\n            }\r\n        };\r\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n        ComponentWrap.prototype.componentDidUpdate = function (prevProps, prevState, snapshot) {\r\n            var _a;\r\n            console.log('prevState.isReady', prevState.isReady);\r\n            console.log('this.state.isReady', this.state.isReady);\r\n            var lock = this.lock;\r\n            if (lock) {\r\n                this.lock = false;\r\n            }\r\n            else if (prevState.isReady === this.state.isReady) {\r\n                var name_1 = config.name;\r\n                // @ts-ignore\r\n                (_a = window[name_1]) === null || _a === void 0 ? void 0 : _a.update(prevProps, this.props);\r\n            }\r\n        };\r\n        ComponentWrap.prototype.componentWillUnmount = function () {\r\n            var _a;\r\n            var name = config.name;\r\n            // @ts-ignore\r\n            (_a = window[name]) === null || _a === void 0 ? void 0 : _a.unmount();\r\n        };\r\n        /**\r\n         * refresh - 刷新\r\n         */\r\n        ComponentWrap.prototype.refresh = function () {\r\n            // 加锁防止自己被update\r\n            this.lock = true;\r\n            this.forceUpdate();\r\n        };\r\n        ComponentWrap.prototype.render = function () {\r\n            var _this = this;\r\n            var name = config.name;\r\n            var isReady = this.state.isReady;\r\n            var children = this.props.children;\r\n            return (react_1.default.createElement(context_1.default.Consumer, null, function (el) {\r\n                var _a;\r\n                _this.el = el;\r\n                return (react_1.default.createElement(context_1.default.Provider, { value: (_a = window[name]) === null || _a === void 0 ? void 0 : _a.getChild() }, isReady && window[name] ? children : null));\r\n            }));\r\n        };\r\n        return ComponentWrap;\r\n    }(react_1.default.Component));\r\n}\r\nexports.createComponent = createComponent;\r\n"],"names":["__extends","this","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__importDefault","mod","__esModule","default","defineProperty","exports","value","createComponent","react_1","require","context_1","loadScript","script","Promise","resolve","el","document","createElement","addEventListener","src","getElementsByTagName","appendChild","loadLink","link","setAttribute","href","loadRemoteResource","_a","scripts","links","all","concat","map","config","container","_super","Component","ComponentWrap","componentDidMount","_c","_this","name","window","bootstrap","props","refresh","_b","mount","then","setState","isReady","componentDidUpdate","prevProps","prevState","snapshot","console","log","state","lock","name_1","update","componentWillUnmount","unmount","forceUpdate","render","children","Consumer","Provider","getChild","call","bind"],"mappings":"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"}