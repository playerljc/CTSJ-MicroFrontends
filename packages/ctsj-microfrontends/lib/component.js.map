{"version":3,"file":"component.js","sources":["component.js"],"sourcesContent":["\"use strict\";\r\nvar __extends = (this && this.__extends) || (function () {\r\n    var extendStatics = function (d, b) {\r\n        extendStatics = Object.setPrototypeOf ||\r\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\r\n        return extendStatics(d, b);\r\n    };\r\n    return function (d, b) {\r\n        extendStatics(d, b);\r\n        function __() { this.constructor = d; }\r\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n    };\r\n})();\r\nvar __importDefault = (this && this.__importDefault) || function (mod) {\r\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nexports.createComponent = void 0;\r\nvar react_1 = __importDefault(require(\"react\"));\r\nvar react_loading_skeleton_1 = __importDefault(require(\"react-loading-skeleton\"));\r\nvar context_1 = __importDefault(require(\"./context\"));\r\nvar emitter_1 = require(\"./emitter\");\r\nvar actions_1 = require(\"./actions\");\r\n/**\r\n * loadScript - 加载script脚本\r\n * @param script\r\n * @return Promise\r\n */\r\nfunction loadScript(script) {\r\n    return new Promise(function (resolve) {\r\n        var el = document.createElement('script');\r\n        el.addEventListener('load', function () {\r\n            resolve();\r\n        });\r\n        el.src = script;\r\n        document.getElementsByTagName('head')[0].appendChild(el);\r\n    });\r\n}\r\n/**\r\n * loadLink - 加载css文件\r\n * @param link\r\n * @return Promise\r\n */\r\nfunction loadLink(link) {\r\n    return new Promise(function (resolve) {\r\n        var el = document.createElement('link');\r\n        el.setAttribute('rel', 'stylesheet');\r\n        el.addEventListener('load', function () {\r\n            resolve();\r\n        });\r\n        el.href = link;\r\n        document.getElementsByTagName('head')[0].appendChild(el);\r\n    });\r\n}\r\n// @ts-ignore\r\n/**\r\n * loadRemoteResource - 加载远程所有的脚本和样式资源\r\n * @param scripts\r\n * @param links\r\n * @return Promise\r\n */\r\nfunction loadRemoteResource(_a) {\r\n    var scripts = _a.scripts, links = _a.links;\r\n    // @ts-ignore\r\n    return Promise.all([].concat(\r\n    // @ts-ignore\r\n    (scripts || []).map(function (script) { return loadScript(script); }), (links || []).map(function (link) { return loadLink(link); })));\r\n}\r\n/**\r\n * createComponent\r\n * @param config\r\n * @param container\r\n * @return React.ReactElement\r\n */\r\nfunction createComponent(config, container) {\r\n    /**\r\n     * ComponentWrap\r\n     * @class ComponentWrap\r\n     * @classdesc ComponentWrap\r\n     */\r\n    // @ts-ignore\r\n    return /** @class */ (function (_super) {\r\n        __extends(ComponentWrap, _super);\r\n        function ComponentWrap(props) {\r\n            var _this = _super.call(this, props) || this;\r\n            _this.el = null;\r\n            _this.lock = false;\r\n            // 之前变化的location\r\n            _this.preChangeLocation = null;\r\n            _this.state = {\r\n                isReady: false,\r\n            };\r\n            // 路由发生变化的回调\r\n            _this.onLocationChange = _this.onLocationChange.bind(_this);\r\n            _this.refresh = _this.refresh.bind(_this);\r\n            return _this;\r\n        }\r\n        ComponentWrap.prototype.componentDidMount = function () {\r\n            var _this = this;\r\n            var _a, _b, _c;\r\n            // 1.接收到props中的history对象\r\n            var history = this.props.history;\r\n            // 2. 使用history的listen方法添加自定义监听事件 参数为一个回调函数 即：路由改变之后执行的方法\r\n            this.unListen = history.listen(this.onLocationChange);\r\n            var name = config.name;\r\n            // 如果没有加载远程资源，则加载远程资源\r\n            // @ts-ignore\r\n            if (!window[name]) {\r\n                var scripts = config.scripts, links = config.links;\r\n                loadRemoteResource({\r\n                    scripts: scripts,\r\n                    // @ts-ignore\r\n                    links: links,\r\n                }).then(function () {\r\n                    var _a, _b, _c;\r\n                    // @ts-ignore\r\n                    (_a = window[name]) === null || _a === void 0 ? void 0 : _a.bootstrap({\r\n                        props: _this.props,\r\n                        config: config,\r\n                        el: _this.el || container,\r\n                        refresh: _this.refresh,\r\n                    });\r\n                    // @ts-ignore\r\n                    (_c = (_b = window[name]) === null || _b === void 0 ? void 0 : _b.mount()) === null || _c === void 0 ? void 0 : _c.then(function () {\r\n                        _this.setState({\r\n                            isReady: true,\r\n                        });\r\n                    });\r\n                });\r\n            }\r\n            // 加载过远程资源\r\n            else {\r\n                // @ts-ignore\r\n                (_a = window[name]) === null || _a === void 0 ? void 0 : _a.bootstrap({\r\n                    props: this.props,\r\n                    config: config,\r\n                    el: this.el || container,\r\n                    refresh: this.refresh,\r\n                });\r\n                // @ts-ignore\r\n                (_c = (_b = window[name]) === null || _b === void 0 ? void 0 : _b.mount()) === null || _c === void 0 ? void 0 : _c.then(function () {\r\n                    _this.setState({\r\n                        isReady: true,\r\n                    });\r\n                });\r\n            }\r\n        };\r\n        // eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n        ComponentWrap.prototype.componentDidUpdate = function (prevProps, prevState, snapshot) {\r\n            var _a;\r\n            console.log('prevState.isReady', prevState.isReady);\r\n            console.log('this.state.isReady', this.state.isReady);\r\n            var lock = this.lock;\r\n            if (lock) {\r\n                this.lock = false;\r\n            }\r\n            else if (prevState.isReady === this.state.isReady) {\r\n                var name_1 = config.name;\r\n                // @ts-ignore\r\n                (_a = window[name_1]) === null || _a === void 0 ? void 0 : _a.update(prevProps, this.props);\r\n            }\r\n        };\r\n        ComponentWrap.prototype.componentWillUnmount = function () {\r\n            var _a;\r\n            this.unListen();\r\n            var name = config.name;\r\n            // @ts-ignore\r\n            (_a = window[name]) === null || _a === void 0 ? void 0 : _a.unmount();\r\n        };\r\n        /**\r\n         * refresh - 刷新\r\n         */\r\n        ComponentWrap.prototype.refresh = function () {\r\n            // 加锁防止自己被update\r\n            this.lock = true;\r\n            this.forceUpdate();\r\n        };\r\n        /**\r\n         * onLocationChange - 路由改变之后执行的方法\r\n         * @param location\r\n         */\r\n        ComponentWrap.prototype.onLocationChange = function (location) {\r\n            if (!this.preChangeLocation) {\r\n                this.preChangeLocation = location;\r\n                emitter_1.routerChangeEmitter.trigger(actions_1.ROUTER_CHANGE, location);\r\n            }\r\n            else if (this.preChangeLocation.pathname !== location.pathname) {\r\n                this.preChangeLocation = location;\r\n                emitter_1.routerChangeEmitter.trigger(actions_1.ROUTER_CHANGE, location);\r\n            }\r\n        };\r\n        ComponentWrap.prototype.render = function () {\r\n            var _this = this;\r\n            var name = config.name;\r\n            var isReady = this.state.isReady;\r\n            var children = this.props.children;\r\n            return (react_1.default.createElement(context_1.default.Consumer, null, function (el) {\r\n                var _a;\r\n                _this.el = el;\r\n                return (react_1.default.createElement(context_1.default.Provider, { value: (_a = window[name]) === null || _a === void 0 ? void 0 : _a.getChild() }, isReady && window[name] ? children : react_1.default.createElement(react_loading_skeleton_1.default, null)));\r\n            }));\r\n        };\r\n        return ComponentWrap;\r\n    }(react_1.default.Component));\r\n}\r\nexports.createComponent = createComponent;\r\n"],"names":["__extends","this","extendStatics","d","b","Object","setPrototypeOf","__proto__","Array","p","hasOwnProperty","__","constructor","prototype","create","__importDefault","mod","__esModule","default","defineProperty","exports","value","createComponent","react_1","require","react_loading_skeleton_1","context_1","emitter_1","actions_1","loadScript","script","Promise","resolve","el","document","createElement","addEventListener","src","getElementsByTagName","appendChild","loadLink","link","setAttribute","href","loadRemoteResource","_a","scripts","links","all","concat","map","config","container","_super","Component","ComponentWrap","componentDidMount","_this","history","props","unListen","listen","onLocationChange","name","window","bootstrap","refresh","_c","_b","mount","then","setState","isReady","componentDidUpdate","prevProps","prevState","snapshot","console","log","state","lock","name_1","update","componentWillUnmount","unmount","forceUpdate","location","preChangeLocation","pathname","routerChangeEmitter","trigger","ROUTER_CHANGE","render","children","Consumer","Provider","getChild","call","bind"],"mappings":"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"}